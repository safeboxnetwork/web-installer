kind: pipeline
name: default
trigger:
  branch:
    - main
  event:
    - push
workspace:
  path: /drone/src

environment:
  REPO_NAME: web-installer
  IMAGE_NAME: web-installer
  REGISTRY_SERVER_NAME: registry.format.hu

steps:
  - name: build image
    image: plugin/docker
    commands:
      - cd /drone/src/
      - docker build --platform linux/amd64 -t $${REGISTRY_SERVER_NAME}/$${IMAGE_NAME}:amd64 -f Dockerfile .
      - docker push $${REGISTRY_SERVER_NAME}/$${IMAGE_NAME}:amd64
      - docker build --platform linux/arm64 -t $${REGISTRY_SERVER_NAME}/$${IMAGE_NAME}:arm64 -f Dockerfile .
      - docker push $${REGISTRY_SERVER_NAME}/$${IMAGE_NAME}:arm64
    when:
      branch:
        - main
    volumes:
      - name: docker
        path: /var/run/docker.sock
 
volumes:
  - name: docker
    host:
      path: /var/run/docker.sock
